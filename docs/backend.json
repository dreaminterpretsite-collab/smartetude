{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile within the Smart Études CI application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "name": {
          "type": "string",
          "description": "The user's full name."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "className": {
          "type": "string",
          "description": "The user's class (e.g., troisieme, seconde, terminale)."
        },
        "inscriptionDate": {
          "type": "string",
          "description": "The date the user registered.",
          "format": "date-time"
        },
        "solde": {
          "type": "number",
          "description": "The user's current balance in FCFA."
        },
        "referralId": {
          "type": [
            "string",
            "null"
          ],
          "description": "The ID of the user who referred this user."
        },
        "courseAccessExpires": {
          "type": [
            "number",
            "null"
          ],
          "description": "Timestamp indicating when the user's access to courses expires."
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "className",
        "inscriptionDate",
        "solde"
      ]
    },
    "Exercise": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Exercise",
      "type": "object",
      "description": "Represents an exercise submitted by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Exercise entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Exercise)"
        },
        "subject": {
          "type": "string",
          "description": "The subject of the exercise."
        },
        "imageUri": {
          "type": "string",
          "description": "The data URI of the submitted image."
        },
        "submissionDate": {
          "type": "string",
          "description": "The date the exercise was submitted.",
          "format": "date-time"
        },
        "solution": {
          "type": "string",
          "description": "The AI-generated solution to the exercise."
        }
      },
      "required": [
        "id",
        "userProfileId",
        "subject",
        "imageUri",
        "submissionDate",
        "solution"
      ]
    },
    "Payment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Payment",
      "type": "object",
      "description": "Represents a payment made by a user to recharge their account.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Payment entity."
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Payment)"
        },
        "userEmail": {
          "type": "string",
          "description": "The user's email address used for the payment.",
          "format": "email"
        },
        "paymentDate": {
          "type": "string",
          "description": "The date the payment was made.",
          "format": "date-time"
        },
        "amount": {
          "type": "number",
          "description": "The amount paid in FCFA."
        },
        "waveTransactionId": {
          "type": "string",
          "description": "The Wave transaction ID for the payment."
        },
        "status": {
          "type": "string",
          "description": "The status of the payment (pending, completed, failed)."
        }
      },
      "required": [
        "id",
        "userProfileId",
        "userEmail",
        "paymentDate",
        "amount",
        "waveTransactionId",
        "status"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profiles. Only the user or an admin can access this data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/exercises/{exerciseId}",
        "definition": {
          "entityName": "Exercise",
          "schema": {
            "$ref": "#/backend/entities/Exercise"
          },
          "description": "Stores exercises submitted by a user. Path-based ownership: only the user can access their exercises.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "exerciseId",
              "description": "The unique identifier of the exercise."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/payments/{paymentId}",
        "definition": {
          "entityName": "Payment",
          "schema": {
            "$ref": "#/backend/entities/Payment"
          },
          "description": "Stores payment history for a user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "paymentId",
              "description": "The unique identifier of the payment."
            }
          ]
        }
      },
      {
        "path": "/payments/{paymentId}",
        "definition": {
          "entityName": "Payment",
          "schema": {
            "$ref": "#/backend/entities/Payment"
          },
          "description": "Root collection for all payments, facilitating admin validation. Includes denormalized 'userProfileId' and 'userEmail' for authorization independence.",
          "params": [
            {
              "name": "paymentId",
              "description": "The unique identifier of the payment."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "roles_admin",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Confers admin rights. Existence over content. If a document exists with the user's ID, the user is an admin.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to securely manage user profiles, exercises, payments, and admin roles for the Smart Études CI application. The structure prioritizes authorization independence and simplifies security rules by denormalizing authorization data and segregating data based on access requirements. User-owned data is stored in hierarchical paths for simple ownership-based security rules. Collaborative data and global roles use existence checks. The structure is optimized for list operations. All paths follow semantic naming conventions for clarity.\n\n**Authorization Independence:**\n\n*   The `exercises` and `payments` subcollections under `/users/{userId}` inherently inherit authorization context from the user's ID. This path-based ownership allows security rules to directly verify that the authenticated user is the owner of the data without requiring `get()` calls to parent documents.\n*   The `/payments/{paymentId}` collection includes `userProfileId`, and `userEmail` fields, denormalizing the user information required to validate and process the payment. Although this collection is intended for admin use, the denormalized data allows admin rules to validate the payment request without fetching user profile data.\n\n**Segregation:**\n\n*   User profiles are stored in `/users/{userId}`, separating them from other data and ensuring that only the user or an admin can access their profile information.\n*   Admin roles are managed in `/roles_admin/{userId}`, separate from user profiles, simplifying the process of granting and verifying admin privileges.\n*   The segregation of data enables clear and simple security rules, as each collection has a distinct access requirements.\n\n**QAPs (Rules are not Filters):**\n\n*   The structure enables secure `list` operations by following the principle of segregation. Since each collection has a homogeneous security posture, rules can be written to allow listing of documents without filtering based on document content.\n*   Path-based ownership (`/users/{userId}/exercises/{exerciseId}`) ensures that listing exercises is secure, as the rules can verify that the user is the owner of the exercises.\n*   Admin validation of payments in the `/payments/{paymentId}` collection requires a separate rule set that verifies admin privileges, but the inclusion of the `userProfileId` within each payment enables admins to validate payments without fetching user profile data."
  }
}
